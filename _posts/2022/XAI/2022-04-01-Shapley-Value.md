---
title:  "[XAI] 섀플리 값 (Shapley Value))"
excerpt: "섀플리 값은 모델이 특성을 사용한 것과 사용하지 않고 예측하는 것을 비교하여 특성의 중요도를 계산합니다. 그러나 특성의 순서도 예측에 영향을 줄 수 있기 때문에 가능한 모든 순서를 다 고려하게 되므로 모든 특성이 다 공평하게 비교됩니다."

categories:
  - Explainable-AI
# tags:
#   - [Machine Learning, XAI,Surrogate Analysis ]

toc: true
toc_sticky: true
use_math: true

# date: 2022-03-29
# last_modified_at: 2022-03-29
---
<!-- # Surrogate Analysis -->
# SHAP

Shapley 값을 설명하기 앞서, 몇 가지 개념에 대해 설명하겠습니다. 

# 1. Local과 Global

나이, 성별 및 직업 등 특성을 가지고 그들이 컴퓨터 게임을 좋아할지 여부를 예측하려 합니다.

![Untitled.png](/assets/images/posts/XAI/2022-04-01-Shapley-Value/Untitled.png)


여기에서는 두 가지 해석 방식이 있습니다:

1. 전역(Global) 수준 - 전체 데이터를 보고 , 머신러닝 알고리즘이 예측함에 있어 가장 중요하다고 판단된 특성은 무엇일까요?
    
    XGBoost의 get_score() 함수(의사결정을 위한 데이터를 분할하는데 특성이 사용된 횟수를 계산하는 함수입니다)는 모든 데이터에서 학습된 내용을 살펴보기 때문에, 전역 피처 중요도를 고려한 예입니다.
    
2. 지역(Local) 수준 - 개개인의 특성을 봤을 때, 아마도 나이가 가장 중요한 특성일 것 같습니다. 그리고 젊은 사람일수록 더욱 게임을 좋아하는 것 같습니다.
    
    하지만 만약에 철수의 나이는 50세이고, 비디오게임의 테스터로 일하고 있습니다. 이는 그가 컴퓨터 게임을 좋아하는지를 결정하는 데 그의 나이보다 직업이 휠씬 더 중요할 가능성이 높습니다.
    
    철수에게 가장 중요한 특성을 식별하는 것은 특히 ‘지역’(개인)수준에서 피처 중요도를 찾는 것입니다.
    

이처럼 전역의 수준에서는 전체적인 집단 성향을 볼 수 있는 반면, 지역의 수준에서는 개인의 특성을 볼 수 있습니다. 근데 여기서 중요한 점은, 이 둘은 다를 수도 있다는 것입니다. 

## 2. 설명가능성과 복잡도의 트레이드 오프

사실 위에서 다룬 문제보다 더 중요하고 복잡한 문제가 있습니다.

예를 들어, 평범한 선형회귀 모델이 있습니다:

$$
f(x_1, x_2, \cdots, x_n)=\phi_1x_1+\phi_2x_2+\cdots+\phi_nx_n
$$

여기서, 특성는 $x_i$이고, 가중치(또는 계수)는 $\phi_i$입니다. 그리고 이들이 더해져 출력값$f(x_1, x_2, \cdots, x_n)$이 나옵니다. 

위의 컴퓨터 게임 선호도를 예로 들면, 특성은 $x_{Age}, x_{Gender}, x_{Job}$입니다. 

이 예제에서는 쉽게 중요한 특성을 찾아낼 수 있습니다:

만약에 $\phi_i$의 절댓값이 매우 크다면, 특성 $x_i$는 출력값에 매우 큰 영향을 줄 것입니다.

(예를 들어  만약 |$\phi_{Age}$|가 크다면, 나이는 매우 중요한 특성이라고 할 수 있습니다)

여기서 주의해야 될 점은,  모델이 너무 단순하여 선형 관계만 예측할 수도 있다는 것입니다. 

예를 들어, 어쩌면 나이가 가장 중요한 특성일 수도 있으며, 12세에서 18세 사이인 경우 다른 어떤 연령대보다 컴퓨터 게임을 좋아할 가능성이 휠씬 더 높습니다. 하지만, 이는 비선형 관계이기 때문에 선형회귀에서는 이를 알아낼 수 없습니다.

더 복잡한 관계를 알아내기 위해서는 더 복잡한 모델이 필요합니다. 하지만, 복잡한 모델을 사용할수록, 해석의 용이성을 잃을 수 밖에 없습니다. 

비선형 또는 더욱 복잡한 관계 (예를 들어 성별에 따라 나이가 중요한가? )를 알아내려면, 그 모델의 해석하는 것은 매우 까다로워집니다.

그렇기 때문에 간순한 관계만 드러낼 수 있는 해석하기 쉬운 모델과 복잡한 관계로 이루어진 모델 사이에 트레이트 오프 관계가 있습니다.

그러면 복잡한 모델은 어떻게 해석할 수 있을까요?

## 3. 복잡한 모델의 설명성

선형회귀는 모델을 설명하기에 좋습니다.

 각 특성 $x_i$에 가중치 $\phi_i$를 부여합니다. 이는 선형성을 갖습니다. 그리고 특성 $~~x_i~~$가 모델의 출력값에 얼마나 영향을 미치는지 알 수 있습니다. 

선형인 만큼 간단하지만, 이 모델의 단점은 명확합니다 - 복잡한 관계에 대해서는 예측할 수 없습니다.

비록 많은 데이터 포인트를 걸쳐, 가중치 $\phi$는 복잡한 관계를 표현할 수 없습니다. 하지만 지역 수준에서는 잘 표현할 수 있습니다.  단일 예측의 경우, 각 변수가 실제로 일정한 값을

예를 들어, 아까 철수의 나이는 50, 직업은 비디오게임 테스터이며, 컴퓨터 게임을 좋아합니다. 철수의 경우, $\phi_{Job}$은 클 것이고,  $\phi_{Age}$ 은 작을 것입니다.

하지만 위의 Bobby를 예로 들면, 나이는 14이입니다. 예측모델이 나이가 15세 이하이기 때문에 컴퓨터 게임을 좋아할 것이라고 보기 때문에 Bobby의 $\phi_{Age}$는 높을 것입니다. 

우리는 데이터의 비선형 패턴을 학습한 복잡한 모델을 가져와 개별 데이터 포인트를 설명하는 여러 개의 선형 모델로 분해했습니다.

여기서 중요한 점은, 설명을 위한 $\phi$들은 모델의 결괏값이 아니며, 우리는 이 모델을 해석하는 데 사용했습니다.

이 모든 단순하고(선형적) 개별적인 모델을 집계함으로써 오리는 모델이 모든 개개인에 어떻게 작동하는지 이해할 수 있습니다.

이제 정리를 시작해 보겠습니다:

전체 모델(복잡한 모델)을 설명하기보다는 복잡한 모델이 하나의 데이터 포인트에 대해 어떻게 작동하는지 설명하려고 합니다.

이를 설명하기 위해 선형 모델 $g$를 사용하겠습니다.

그리고 모델을 더욱 간단하게 만들기 위해, 우리는 가중치 $\phi$를 기존 특성 값에 곱하지 않겠습니다. 대신, 특징이 있으면 이를 1, 없으면 0을 곱하겠습니다.

컴퓨터 게임을 좋아하는 사람을 예측하는 경우, 다음과 같은 결과를 얻을 수 있습니다:

$$
g_{철수}=\phi_{철수 Age}+\phi_{철수 Gender}+\phi_{철수 Job}
$$

$g_{철수}=p_{철수}$일 때, 철수에 대한 모델 $g$와 기존 복잡한 모델의 예측이 같다는 것입니다.

위의 수식에서 주의해야 될 점은 모든 가중치 $\phi$가 철수에게만 적용된다는 것입니다. 만약 모델이 Bobby에 대해 어떻게 동작했는지 알고 싶다면 새로운 가중치 세트를 찾아야 됩니다.

Bobby는 직업이 없습니다. 해당 특성 $x_{BobbyJob}$이 존재하지 않기 때문에 $\phi_{BobbyJob}$에 0을 곱해줍니다. Bobby의 간단한 모델은 다음과 같습니다:

$$
g_{Bobby}=\phi_{bobbyAge}+\phi_{BobbyGender}
$$

이 모든 데이터 포인트에 대해 이 작업을 수행하고 집계하여 이 모델 $g$가 전역적으로 어떻게 작동하는지 알 수 있습니다.

이제 섀플리 값에 대해 설명해 보겠습니다.

# 4. **Shapley Value**

$\phi$ 값을 찾는 솔루션은 게임이론에서 먼저 등장했습니다. 

이는 섀플리(1953)가 제안한 방법으로, 게임 참가자에게 전체 성과물에 대한 기여도에 따라 보상을 배정하는 방식입니다. 참가자는 협력을 하고, 이 협력을 통해 일정 이익을 얻습니다.

만약 $n$명이 참가자가  협력을 한다면, $v(N)$이라는 가치를 만들어냈습니다. 그러면 이때 어떤 방식으로 $v(N)$에 대해 분배를 해야 될까요?

다음 조건은 Shapely 값에 따라 충족하면 게임은 ‘공정’하다는 것을 의미합니다.

1. 모든 사람이 받는 금액의 합은 총 보상과 같아야 합니다.
2. 두 사람의 기여도가 같다면, 동일한 금액을 받아야 됩니다.
3. 기여를 하지 않은 사람은 보상을 받을 수 없습니다.
4. 만약 게임을 두 번 진행하게 된다면, 두 번째 게임의 보상은 첫 번째 게임의 보상과 같아야 합니다.

일단 간단한 예시를 하나 보겠습니다.

## 예시 1

농사를 짓기 위해, 세 명의 농사꾼A, B, C가 모여, 총 100kg의 쌀을 수확했습니다. 이들은 수확한 쌀을 합리적으로 나누려고 합니다. 이때 각 농사꾼의 효율과 협력 하의 효율은 아래와 같습니다.

| ⁍ | 수확량(kg) |
| --- | --- |
| A | 10 |
| B | 30 |
| C | 5 |
| A, B | 50 |
| A, C | 40 |
| B, C | 35 |
| A, B, C | 100 |

이때 총 3!=6가지의 협력이 발생할 수 있습니다:

- A가 B에게 협력요청 → 부분집합 $S$ ; 
B가 C에게 협력요청 → 부분집합 $S$
- A가 C에게 협력요청 → 부분집합 $S$ ; 
C가 B에게 협력요청 → 부분집합 $S$
- A가 B에게 협력요청 → 부분집합 $S$ ; 
B가 C에게 협력요청 → 부분집합 $S$

  $\vdots$

모든 가능한 협력 조합에 대해 발생하는 한계 수입(Marginal revenue) 를 고려합니다. 

즉, 협력 요청 후 발생한 수익의 변화를 보는 것입니다.

$i$ 가 부분집합 $S$에 합류한 후 발생한 공헌이익에 대한 식은 다음과 같습니다:

$$
\delta_i(S)=v(S\cup\{i\})-v(S)
$$

이 예제를 조금 더 구체적으로 생각해 보겠습니다. 예를 들어 A의 공헌도를 계산해 보겠습니다. 그럼 부분집합 $S$의 가능한 집합은 다음과 같습니다:

- 부분집합 $S$에는 아무도 없음 → $S$는 공집합
- 부분집합 $S$에는 B 또는 C이 있음 → 부분집합 $S$에는 한 가지 원소만 있음
- 부분집합 $S$에는 B와 C이 있음 → 부분집합 $S$에는 두 가지 원소 다 있음

이렇게 1+2+2 총 5 가지의 경우의 수가 존재합니다. 

이번에는 이 5 가지의 한계 수입을 계산해 보겠습니다. 각 농사꾼의 수입은 다음과 같이 계산됩니다.

| Order | 농사꾼A의 공헌도 | 농사꾼B의 공헌도 | 농사꾼C의 공헌도 |
| --- | --- | --- | --- |
| A | B | C | ⁍(A) = 10 | ⁍(A,B) - ⁍(A) = 50 - 10 = 40 | ⁍(A, B, C) - ⁍(A, B) = 100 - 50 = 50 |
| A | C | B | ⁍(A) = 10 | ⁍(A, B, C) - ⁍(A, C) = 100 - 40 = 60 | ⁍(A, C) - ⁍(A) = 40 - 10 = 30 |
| B | A | C | ⁍(A, B) - ⁍(B) = 50 - 30 = 20 | ⁍(B) = 30 | ⁍(A, B, C) - ⁍(A, B) = 100 - 50 = 50 |
| B | C | A | ⁍(A, B, C) - ⁍(B, C) = 100 - 35 = 65 | ⁍(B) = 30 | ⁍(B, C) - ⁍(B) = 35 - 30 = 5 |
| C | A | B | ⁍(A, C) - ⁍(A) = 40 - 5 = 35 | ⁍(A, B, C) - ⁍(A, C) = 100 - 40 = 60 | ⁍(C) = 5 |
| C | B | A | ⁍(A, B, C) - ⁍(B, C) = 100 - 35 = 65 | ⁍(B, C) - ⁍(C) = 35 - 5= 30 | ⁍(C) = 5 |

위의 순서만 바꿨을 뿐인데 값이 달라졌습니다. 

마지막으로 거의 모든 경우의 수를 고려했을 때의 평균 수입, 즉 섀플리 값을 계산해 보겠습니다.

| Contributor | Shapley Calculation | Shapley Value |
| --- | --- | --- |
| A | ⁍ | 34.17 |
| B | ⁍ | 41.66 |
| C | ⁍ | 24.17 |

여기서 주의해야 될 점은, 이 세 명의 섀플리 값의 합은 100이라는 것입니다. 여기서의 섀플리 값은  개인이 수확한 쌀의 양이라고 생각하면 조금 더 이해하기 쉽습니다.

## 예시 2

다시 컴퓨터 게임 선호도 예시로 돌아와, 섀플리 값의 조건을 적용해 보겠습니다.

1. 만약 두 특징이 최종 예측값에 대한 기여도가 같다면 그들의 가중치 $\phi$의 값도 같아야 됩니다.
2. 만약 특성이 최종 예측에 아무런 기여도 하지 않았다면(또는 누락됐다면), $g$에 대한 기여도는  0이어야 합니다. 즉, 가중치 $\phi$ 는 0이 됩니다.
3. 만약 $g_{철수+Bobby}$를 계산한다면, $g_{철수+Bobby}=g_{철수}+g_{Bobby}$이 되어야 합니다.

우리의 간단한 모델이 기본적으로 규칙 3과 4를 준수한다는 점은 주목할 필요가 있습니다.

그리고 $\phi$를 계산하는 방법은 한 가지 밖에 없기 때문에 규칙 1과 2도 준수합니다.

그럼 이제  섀플리 값을 계산해 보겠습니다.

$$
\phi_i=\sum_{S\subseteq N / i}\frac{|S|!(|F|-|S|-1)!}{n!}[p(S\cup i)-p(S)]
$$

- $\phi_i$: $i$ 데이터에 대한 섀플리 값
- $F$: 전체 집합
- $S$: 전체 집합에서 $i$번째 데이터가 빠진 나머지의 모든 부분 집합
- $p(S\cup i)$: $i$ 번째 데이터를 포함한 (=전체) 기여도, 즉 본래 살펴보고자 했던 특성을 제외한 데이터 예측치들의 평균입니다.
- $p(S)$: $i$ 번째 데이터가 빠진 나머지 부분 집합의 기여도, 즉 본래 살펴보고자 했던 특성이 포함된 예측치들의 평균입니다.

$$
Importance\ of\ i=p(with\ i)-p(without\ i)
$$

위의 수식은 보다 더 직관적입니다. 특성을 추가하고 새로운 특성이 들어올 때마다 모델의 예측이 어떻게 변하는지 볼 수 있습니다. 모델 예측의 변화는 기본적으로 특성들의 영향이라고 할 수 있습니다.

그러나, 여기서 중요한 점은 특성을 추가하는 순서는 해당 값을 할당하는 데 있어서 매우 중요하게 작용합니다.

Bobby의 예시를 다시 한번 보면, 그의 나이는 15세 미만이고, 성별은 남성이라는 사실은 그가 컴퓨터 게임을 좋아할 가능성이 높다는 것을 의미합니다. 

위의 예시 그림을 봤을 때,  나이는 둘 다 15세 미만인데, 성별이 남성이라서  예측 점수가 여성에 비해 1.9가 높게 나왔습니다. 

우리는 모델이 Bobby가 두 가지 정보를 모두 가지고 있을 때만 컴퓨터 게임을 좋아할 가능성이 있는 후보임을 알 수 있기 때문입니다. 그리고 이는 두 번째로 추가된 특성(성별)이 불균형적으로 높은 가중치를 갖게 된다는 것을 의미합니다.

조금 더 자세하게 설명하기 위해, XGBoost를 사용하고, 트리에서 분할되는 값이 누락된 경우 그 아래에 있는 평균을 계산한다고 가정해 보겠습니다.

### 1단계 - Bobby의 나이, 성별

모델에 Bobby의 정보를 입력했을 때, 첫 번째 분할인 나이(15세 미만)에서 왼쪽으로 이동했습니다. 그리고 만약 아직 성별의 특성을 고려하지 않았기 때문에 아래 리프의 평균으로 기여도를 할당하는데, 여기서는 $\frac{2.0+0.1}{2}=1.05$ 입니다. 그래서 해당 특성(나이)의 기여도는 1.05라고 할 수 있습니다.

다음으로, 모델이 그가 남성이라는 것을 알았습니다, 그리고 점수를 2로 할당했습니다. 그렇기에 이 특성(성별)의 기여도는 $2-1.05=0.95$ 입니다.

그럼으로 이 예시에서 $\phi_{AgeBobby}=1.05$, $\phi_{GenderBobby}=0.95$입니다.

### 2단계 - 성별을 먼저 보고 나이를 본다고 가정

성별만 있는 경우 모델은 나이에 대해서는 기준을 정할 수 없습니다. 따라서 루트리프 아래의 모든 리프에 평균을 취해야됩니다. 

먼저 깊이가 2일 때 평균은 다음과 같습니다:

- $\frac{2+0.1}{2}=1.05$

이 결과는 다른 깊이가 1인 리프의 평균이 됩니다:

- $\frac{1.05+(-1)}{2}=0.025$

최종적으로 특성(성별)의 기여도는  0.025가 됩니다.

그런 다음 모델이 데이터 포인트가 15세 미만임을 알게된다면 2점을 부여합니다. 

특성(나이)의 기여도는 다음과 같습니다:

 $2-0.025=1.975$

이 예시에서 $\phi_{AgeBobby}=1.975$, $\phi_{GenderBobby}=0.025$입니다.

그럼 우리는 과연 $\phi_{AgeBobby}$에게 어떤 값을 할당해야될까요?

$\phi_{AgeBobby}$에 1.975를 할당한다면, 우리는 위의 조건1에 따라 $\phi_{GenderBobby}$에 0.025를 할당해야될까요?

이렇게 할당하는 것은 매우 이상적이지만, 이는 1단계의 결과$\phi_{AgeBobby}=1.05$와 $\phi_{GenderBobby}=0.95$를 생략했습니다. 

그럼 섀플리 값은 어떻게 계산해야될까요?

## Shapley Value 계산하기

이번에는 Bobby 나이의 섀플리 값을 계산해보겠습니다.

먼저, 세트 $S$를 구성해야 합니다. 이는 Bobby의 나이를 제외하고 가능한 모든 기능 조합입니다.

여기서, Bobby에게는 특성(직업)이 없기 때문에, 특성은 성별 하나만 있기 때문에 두 세트가 생성됩니다: {$x_{Gender}$}와 {}.

그 다음 각 세트의 $\frac{|S|!(n-|S|-1)!}{n!}(p(S\cup i )-p(S))$를 계산합니다. 현재  2개의 특성( {$x_{Gender}$}와 {})이 있으므로, $n$=2입니다.

1. $S=\{\}$일때:
    
    $$
    |S|=0,|S|!=1
    $$
    
    특성이 없는 모델의 예측은 모든 리프의 평균이며 0.025로 계산되었습니다. 또한 나이만 봤을 때는 1.05로 계산되었습니다.
    
    $$
    p(S\cup i)-p(S)=1.05-0.025=1.025
    $$
    
    그래서 수식은 다음과 같습니다.
    
    $$
    \frac{|S|!(n-|S|-1)!}{n!}(p(S\cup i )-p(S))=\frac{1(2-1)!}{2!}(1.025)=0.5125
    $$
    
2. $S={x_{Gender}}$일 때:
    
    $$
    |S|=1,|S|!=1
    $$
    
    모델의 예측은 성별만 있을 경우 0.025, 나이와 성별 모두 있을 경우 2라고 했습니다. 그래서 다음과 같이 쓸 수 있습니다.
    
    $$
    p(S\cup i)-p(S)=2-0.025=1.975
    $$
    
    그래서 수식은 다음과 같습니다.
    
    $$
    \frac{|S|!(n-|S|-1)!}{n!}(p(S\cup i )-p(S))=\frac{1(2-1)!}{2!}(1.972)=0.9875
    $$
    

최종 섀플리 값은 다음과 같습니다.

$$
\phi_{AgeBobby}=0.9875+0.5125=1.5
$$

요약하면 섀플리 값은 모델이 특성을 사용한 것과 사용하지 않고 예측하는 것을 비교하여 특성의 중요도를 계산합니다. 그러나 특성의 순서도 예측에 영향을 줄 수 있기 때문에 가능한 모든 순서를 다 고려하게 되므로 모든 특성이 다 공평하게 비교됩니다.

하지만, 모든 순서를 고려하기 대문에 빠른 속도로 계산하는 것은 불가능합니다. 



참고

[Interpreting complex models with SHAP values](https://gabrieltseng.github.io/posts/2018-06-20-SHAP/)